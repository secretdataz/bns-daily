$(document).ready(function(){function t(){$("#daily-table-content").html("");var t=[];checkIfResetHappened()&&(settings.data.done[n].done=[],settings.save()),$.each(dailies,function(a,i){var s="";i.dungeon&&(d=echoDungeon(i.dungeon),s='<span class="difficulty-'+echoDifficulty(d.difficulty)+'">'+d.name+"</span>");var o=i.name;"object"==typeof i.name&&("cerulean"==settings.data.faction||"crimson"==settings.data.faction?o=i.name[settings.data.faction]:(o="",$.each(i.name,function(t,e){o+=i.name[t]+" / "}),o=o.slice(0,-3)));var l="";$.each(i.categories,function(t,e){l+='<span class="tag '+e.toLowerCase()+'">'+e+"</span>"}),s&&(i.location=s),t.push(e.tableRow({dailyDone:settings.data.done[n].done[a],dailyValue:i.moneyReward,dailyGold:i.moneyReward,dailyId:a,dailyTags:l,dailyName:o,dailyLocation:i.location,dailyMap:echoMapWithContinent(i.map),dailyGoldRewards:echoGold(Math.round(i.moneyReward*settings.data.goldModifier)),dailyMiscRewards:"&nbsp;"}))}),$("#table-wrapper").html(e.table({rows:t})),$(".daily-table").tablesorter({headers:{5:{sorter:"gold"}},sortList:[[5,1]],widgets:["group"],widgetOptions:{group_saveGroups:!0}}).stickyTableHeaders(),calculateTotalEarnings(),calculateCompletedDailies()}settings.load(),settings.data.localTime=new Date,settings.data.lastModified=new Date(settings.data.lastModified),2==settings.data.version&&(23==settings.data.resetHour&&(settings.data.resetHour=12),ga("send","event","bnsDaily","legacy","=2")),settings.data.version<2&&(console.log("Detected old version, resetting resetHour and resetDate"),settings.setToDefault("resetHour"),settings.setToDefault("resetDate"),ga("send","event","bnsDaily","legacy","2")),settings.data.version<4&&(console.log("Detected old version, moving the done quests to new location"),settings.data.done=[{name:"Default",done:settings.data.done}],settings.save(),ga("send","event","bnsDaily","legacy","4")),settings.update("version",defaultSettings.version),setNextResetTime(),echoTimeTrackerText(),ui.tags(),ui.continents(),ui.nightMode();var e={tableRow:_.template($("#tpl-table-row").html()),table:_.template($("#tpl-table").html()),timeSettingsEdit:_.template($("#tpl-time-settings-edit").html()),tab:_.template($("#tpl-tab").html()),tabInner:_.template($("#tpl-tab-inner").html()),tabEdit:_.template($("#tpl-tab-edit").html())};setInterval(function(){settings.data.localTime=new Date,echoTimeTrackerText(),$("#current-time").text(echoCurrentTime()+" ("+echoCurrentTimezone()+")")},1e3);$(".version").text("v"+settings.data.version),$.tablesorter.addParser({id:"gold",is:function(t,e,a,n){return!1},format:function(t,e,a,n){var i=$(a);return 5==n?i.attr("data-gold")||t:t},parsed:!1,type:"numeric"});var a={getById:function(t){return $(".tab[data-tabid="+t+"]")},save:function(){$(".tab").each(function(t,e){var a=$(e),n=a.attr("data-tabid"),i=$(".tab-name",a).text();settings.data.done[n]||(settings.data.done[n]={done:[]}),settings.data.done[n].name=i}),settings.save()},load:function(){$(".tab").remove(),_.each(settings.data.done,function(t){t&&a.add(t.name)}),$(".tab:first-child").addClass("active")},add:function(t){var n=$(".tab").length,i="Tab "+(n+1);t&&(i=t),console.log("Created new tab with ID ",n),$("#tabs").append(e.tab({tabId:n,tabName:i})),n>=5&&$("#add-tab").hide(),a.save()},remove:function(t){var e=a.getById(t);console.log("Removed tab with ID  ",t),$(".tab").filter(function(){return $(this).attr("data-tabid")>t}).each(function(t,e){$(this).attr("data-tabid",$(this).attr("data-tabid")-1)}),$("#add-tab").show(),e.remove(),settings.data.done.splice(t,1),a.save()},edit:function(t){var n=a.getById(t);console.log("Editing tab with ID ",t),n.html(e.tabEdit({tabName:n.attr("data-tabname")})),$(".tab-name-edit",n).focus()},update:function(t,n){var i=a.getById(t);console.log("Updated tab with ID ",t," to ",n),i.attr("data-tabname",n),n||(n="&nbsp;"),i.html(e.tabInner({tabName:n})),a.save()},change:function(e){var i=a.getById(e);console.log("Switched to tab ",e),n=e,t(),$(".tab").removeClass("active"),i.addClass("active")}};a.load();var n=0;ui.selects(),changeDisplayDensity(),$("#premium-modifier").change(function(){settings.update("goldModifier",$(this).val()),calculateMoneyRewards(),calculateTotalEarnings(),ga("send","event","bnsDaily","premiumModifier",$(this).val())}),$("#faction").change(function(){settings.update("faction",$(this).val()),t(),ga("send","event","bnsDaily","faction",$(this).val())}),$("#reset-hour").change(function(){var t=$(this).val();isInt(t)&&(t=parseInt(t)),setResetHour(t,!1),setNextResetTime(),echoTimeTrackerText();var e;6==t&&(e="EU"),ga("send","event","bnsDaily","region",e)}),$(".density-select").click(function(){settings.update("displayDensity",$(this).attr("data-value")),changeDisplayDensity()}),$("#tag-toggle").click(function(){settings.toggle("showTags"),ui.tags(),$(".daily-table").trigger("reflow")}),$("#continent-toggle").click(function(){settings.toggle("showContinents"),ui.continents()}),$("#night-toggle").click(function(){settings.update("nightMode",!$("html").hasClass("night")),ui.nightMode()}),$("#edit-time").click(function(){$("#time-settings-edit").html(e.timeSettingsEdit({currentTime:settings.data.resetTime.getHours()})).toggle(),$(".daily-table").trigger("reflow")}),$("#add-tab").click(function(){a.add()}),$(document).on("click",".daily-table tbody tr",function(){$(this).toggleClass("done"),$(this).hasClass("done")&&ga("send","event","bnsDaily","dailyFinished",$(this).attr("data-id")),console.log($(this).attr("data-id")),settings.data.done[n].done[$(this).attr("data-id")]=!settings.data.done[n].done[$(this).attr("data-id")],settings.data.lastModified=new Date,settings.save(),calculateCompletedDailies(),calculateTotalEarnings()}).on("click","#detect-reset-time",function(){}).on("click","#save-reset-time",function(){}).on("click",".tab",function(t){$(t.target).is(".tab-icon")||a.change($(this).attr("data-tabid"))}).on("click",".edit-tab",function(){a.edit($(this).parent().attr("data-tabid"))}).on("click",".close-tab",function(){a.remove($(this).parent().attr("data-tabid"))}).on("focusout",".tab-name-edit",function(){a.update($(this).parent().attr("data-tabid"),$(this).val())}),$("#table-wrapper").scroll(function(t){console.log(),$(".daily-table thead").css("left",-$(this).scrollLeft()+$("#table-wrapper").position().left)}),$(".debug-dump").click(function(){$("#dump").show().text(btoa(JSON.stringify({userSettings:settings.data,userAgent:navigator.userAgent}))),$("html, body").animate({scrollTop:$(document).height()},"slow"),selectText("dump")}),$(".reset-settings").click(function(){settings.reset(),settings.save(),ui.tags(),ui.continents(),ui.nightMode(),ui.selects(),a.load(),changeDisplayDensity(),t()}),t()});